# 可拓展的分布式系统

### 1、分布式设计

* 节点间并发工作，没有全局锁，某个节点的错误不影响其它节点。
* 只要加入新的节点就可以自由扩展集群的性能。



### 2、接口和存储分离

<img src="/Users/yanghong/Library/Application Support/typora-user-images/image-20221217102853271.png" alt="image-20221217102853271" style="zoom:30%;" />

* 接口服务和数据服务的接口：

  * 实现对象的存取，对象的存取使用REST接口，数据服务与chapter1一样提供REST接口以供数据存取。接口服务节点作为HTTP客户端向数据服务请求对象。

  * 使用消息队列实现数据的异步通信：可以一对一单发，也可以一对多群发。

  * 使用apiSevers exchange来管理数据服务节点的心跳，每一个数据服务节点持续向exchange发送心跳。

    所有接口服务节点启动之后都会创建一个消息队列来绑定这个exchange，任何发给exchange的消息都会被转发给绑定它的消息队列。

    接口服务在收到Get请求时还需要定位该对象被保存在哪个数据服务节点，因此需要有一个dataServers exchange，所有数据服务节点绑定这个exchange并接收来自接口服务的定位消息。则拥有该对象的数据服务节点使用消息单发通知该接口服务节点。

* RabbitMQ消息设计

​		每个接口服务启动后创建自己的消息队列，并绑定到apiServers exchange中。

​		每个数据服务节点，每隔5s就会往apiServers exchange发送一条消息，暴露该服务HTTP监听地址。接口服务节点收到消息之后就会记录该地址。

​		每个数据服务节点启动时创建自己的消息队列，并绑定到dataServer Exchange中。

​		当接口服务需要定位时，会创建一个临时的消息队列，然后发送一条消息给dataServer Exchange，消息的正文是需要定位的对象，返回地址是该临时队列的名字。

​		定位成功的数据服务节点需要向该临时队列发送反馈消息，反馈正文是该数据服务节点自身的监听地址。临时消息队列会在一定时间后关闭，如果在关闭前没有收到任何反馈，则该对象定位失败，接口服务节点就知道对象不存在于数据服务层。

